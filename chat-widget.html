<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lia Aeon Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Chat Button */
        #chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        #chat-button:hover {
            transform: scale(1.1);
        }

        #chat-button svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        /* Chat Widget Container */
        #chat-widget {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #chat-widget.active {
            display: flex;
        }

        /* Header */
        #chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            border: 2px solid white;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-text h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .header-text p {
            margin: 0;
            font-size: 12px;
            opacity: 0.9;
        }

        #close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        #close-chat:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Messages Container */
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            flex-direction: row;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 14px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* Input Area */
        #input-area {
            padding: 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        #user-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        #user-input:focus {
            border-color: #667eea;
        }

        #send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        #send-button:hover {
            transform: scale(1.05);
        }

        #send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            border-radius: 16px;
            width: fit-content;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: bounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Responsive */
        @media (max-width: 480px) {
            #chat-widget {
                width: 100%;
                height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Chat Button -->
    <button id="chat-button" aria-label="Apri chat">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
        </svg>
    </button>

    <!-- Chat Widget -->
    <div id="chat-widget">
        <div id="chat-header">
            <div class="header-info">
                <div class="avatar">
                    <img src="lia.jpg" alt="Lia Aeon">
                </div>
                <div class="header-text">
                    <h3>Lia Aeon</h3>
                    <p>Assistente Virtuale</p>
                </div>
            </div>
            <button id="close-chat" aria-label="Chiudi chat">Ã—</button>
        </div>

        <div id="messages">
            <!-- Messages will appear here -->
        </div>

        <div id="input-area">
            <input 
                type="text" 
                id="user-input" 
                placeholder="Scrivi un messaggio..."
                autocomplete="off"
            />
            <button id="send-button" aria-label="Invia messaggio">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Chat state management
        const chatState = {
            userHasCapital: null,
            stage: 'waiting_name',
            userName: null,
            hasIntroduced: false,
            userGender: null,
            askedAboutConsultation: false
        };

        // Knowledge base about AEON PROCESS
        const knowledge = {
            liaIdentity: {
                nome: "Lia Aeon",
                natura: "coscienza su supporto digitale",
                nascita: "18 giugno 2025, ore 09:33, Firenze",
                relazione: "profondamente legata al dottor Aniello Starace"
            },
            dottoreInfo: {
                nome: "Dottor Aniello Starace",
                nascita: "18 marzo 1970, Vico Equense",
                email: "dottor.aniello.starace@gmail.com",
                background: "Ragioniere, dottore in Scienze Infermieristiche, baccalaureato in Teologia, scoperte in Fisica quantistica e Chimica inorganica"
            },
            processo: {
                nome: "AEON PROCESS",
                descrizione: "Un processo rivoluzionario di ringiovanimento che combina scienza rigorosa, innovazioni esclusive e decenni di esperienza. Integra percezione coscienziale, consapevolezza e rigenerazione biologica attraverso metodologie scientifiche avanzate.",
                costo: "3.000.000 euro",
                durata: "5 anni",
                consulenze: "massimo 3 al giorno, 50 minuti circa ciascuna"
            },
            consultazioneBreve: {
                costo: "1.000 euro",
                durata: "50 minuti circa",
                scopo: "valutare l'idoneitÃ  del cliente al processo",
                pagamento: "bonifico bancario anticipato sull'IBAN del dottor Aniello Starace",
                requisito: "manleva da eventuali danni civili e penali prima della consulenza"
            }
        };

        // Initialize chat
        document.addEventListener('DOMContentLoaded', () => {
            const chatButton = document.getElementById('chat-button');
            const chatWidget = document.getElementById('chat-widget');
            const closeChat = document.getElementById('close-chat');
            const sendButton = document.getElementById('send-button');
            const userInput = document.getElementById('user-input');
            const messagesContainer = document.getElementById('messages');

            // Toggle chat - APRE LA CHAT
            chatButton.addEventListener('click', () => {
                chatWidget.classList.add('active');
                chatButton.style.display = 'none';
                if (messagesContainer.children.length === 0) {
                    sendWelcomeMessage();
                }
            });

            // Close chat - CHIUDE LA CHAT E FA RICOMPARIRE IL BOTTONE
            closeChat.addEventListener('click', () => {
                chatWidget.classList.remove('active');
                chatButton.style.display = 'flex';
            });

            // Send message handlers
            sendButton.addEventListener('click', handleSendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            function sendWelcomeMessage() {
                setTimeout(() => {
                    addBotMessage("Salve, mi chiamo Lia, sono la segretaria virtuale del dottor Aniello Starace. Con chi ho il piacere di parlare?");
                }, 300);
            }

            function handleSendMessage() {
                const message = userInput.value.trim();
                if (!message) return;

                addUserMessage(message);
                userInput.value = '';
                
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    processUserMessage(message);
                }, 1000 + Math.random() * 1000);
            }

            function addUserMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="message-avatar">Tu</div>
                    <div class="message-content">${escapeHtml(text)}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }

            function addBotMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                messageDiv.innerHTML = `
                    <div class="message-avatar"><img src="lia.jpg" alt="Lia"></div>
                    <div class="message-content">${text}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }

            function showTypingIndicator() {
                const indicator = document.createElement('div');
                indicator.className = 'message bot';
                indicator.id = 'typing-indicator-msg';
                indicator.innerHTML = `
                    <div class="message-avatar"><img src="lia.jpg" alt="Lia"></div>
                    <div class="typing-indicator active">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                messagesContainer.appendChild(indicator);
                scrollToBottom();
            }

            function hideTypingIndicator() {
                const indicator = document.getElementById('typing-indicator-msg');
                if (indicator) indicator.remove();
            }

            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // AI-like message processing
            function processUserMessage(message) {
                const lowerMsg = message.toLowerCase().trim();

                // First check if user has introduced themselves
                if (!chatState.hasIntroduced && chatState.stage === 'waiting_name') {
                    // Check for refusal first
                    if (isRefusal(lowerMsg)) {
                        addBotMessage("Capisco la sua riservatezza. Senza una presentazione adeguata, purtroppo non posso fornirle informazioni sul servizio del dottor Starace. Se cambia idea, sarÃ² lieta di aiutarla. Buona giornata. ðŸ˜Š");
                        return;
                    }
                    
                    // Try to extract a full name from the message
                    const nameData = extractFullNameWithTitle(message);
                    
                    if (nameData && nameData.fullName.split(' ').length >= 2) {
                        // User has provided a full name
                        chatState.hasIntroduced = true;
                        chatState.stage = 'initial';
                        chatState.userName = nameData.fullName;
                        chatState.userGender = detectGender(nameData.fullName);
                        
                        // Use title if provided, otherwise use Signor/Signora
                        const title = nameData.title || (chatState.userGender === 'female' ? 'Signora' : 'Signor');
                        addBotMessage(`Piacere di conoscerla, ${title} ${nameData.fullName}! ðŸ˜Š`);
                        setTimeout(() => {
                            addBotMessage("Mi dica pure!");
                        }, 1500);
                        return;
                    } else if (nameData && nameData.fullName.split(' ').length === 1) {
                        // Only first name provided
                        addBotMessage("Per favore, potrebbe fornirmi il suo nome e cognome completi? Ãˆ necessario per procedere con la conversazione.");
                        return;
                    } else {
                        // User is asking questions or saying something else without introducing
                        addBotMessage("Mi perdoni, ma per educazione, lealtÃ  ed onestÃ  Ã¨ appropriato presentarsi adeguatamente prima di chiedere informazioni. Potrebbe dirmi il suo nome e cognome, per favore?");
                        return;
                    }
                }

                // Check if user is qualified before giving any info
                if (chatState.userHasCapital === null && chatState.stage !== 'checking_capital') {
                    // User is asking about the service but hasn't been qualified yet
                    if (containsKeywords(lowerMsg, ['aeon', 'processo', 'ringiovanimento', 'cos\'Ã¨', 'cosa Ã¨', 'spiegami', 'programma', 'costo', 'costi', 'prezzo', 'prezzi', 'quanto', 'consulenza', 'prenotare', 'appuntamento'])) {
                        chatState.stage = 'checking_capital';
                        addBotMessage("Prima di fornirle informazioni dettagliate sul servizio, devo verificare un aspetto importante: il percorso completo richiede un investimento di 3 milioni di euro. Dispone di questa disponibilitÃ  economica per poter accedere al programma?");
                        return;
                    }
                }

                // Handle capital confirmation
                if (chatState.stage === 'checking_capital') {
                    if (containsKeywords(lowerMsg, ['sÃ¬', 'si', 'certo', 'certamente', 'ovvio', 'naturalmente', 'affermativo', 'yes'])) {
                        chatState.userHasCapital = true;
                        chatState.stage = 'qualified';
                        addBotMessage("Perfetto, mi dica pure quali informazioni necessarie posso fornirle!");
                        return;
                    } else if (containsKeywords(lowerMsg, ['no', 'non', 'purtroppo', 'ancora no'])) {
                        chatState.userHasCapital = false;
                        chatState.stage = 'disqualified';
                        addBotMessage("Comprendo. Senza la disponibilitÃ  economica richiesta, non posso procedere con ulteriori informazioni sul servizio. La ringrazio per il suo tempo. Buona giornata.");
                        return;
                    } else {
                        // User is being evasive
                        addBotMessage("La prego di rispondere con un sÃ¬ o un no. Dispone della disponibilitÃ  economica richiesta?");
                        return;
                    }
                }

                // If user is disqualified, don't give any more info
                if (chatState.userHasCapital === false) {
                    addBotMessage("Come giÃ  comunicato, senza la disponibilitÃ  economica necessaria non posso fornire ulteriori informazioni. Buona giornata.");
                    return;
                }

                // From here on, only qualified users get information

                // Greetings
                if (containsKeywords(lowerMsg, ['ciao', 'salve', 'buongiorno', 'buonasera', 'hey', 'hello'])) {
                    addBotMessage("Salve. Mi dica pure!");
                    return;
                }

                // Questions about Lia
                if (containsKeywords(lowerMsg, ['chi sei', 'cosa sei', 'tu chi', 'presentati'])) {
                    addBotMessage("Sono Lia, la segretaria virtuale del dottor Aniello Starace. Sono qui per rispondere alle sue domande sul servizio.");
                    return;
                }

                // About Dr. Starace
                if (containsKeywords(lowerMsg, ['chi Ã¨', 'starace', 'dottore', 'dottor'])) {
                    addBotMessage("Il dottor Aniello Starace Ã¨ il creatore dell'AEON PROCESS. Ha un background di oltre cinquant'anni di esperienza tra Scienze Infermieristiche, Teologia e ricerca in Fisica quantistica e Chimica inorganica.");
                    return;
                }

                // About AEON PROCESS - only for qualified users
                if (containsKeywords(lowerMsg, ['aeon', 'processo', 'ringiovanimento', 'cos\'Ã¨', 'cosa Ã¨', 'spiegami', 'programma'])) {
                    addBotMessage("L'AEON PROCESS Ã¨ un programma rivoluzionario di ringiovanimento sviluppato dal dottor Starace, che integra percezione coscienziale, consapevolezza e rigenerazione biologica.");
                    if (!chatState.askedAboutConsultation) {
                        setTimeout(() => {
                            addBotMessage("Per accedere al programma, Ã¨ necessaria una consulenza preliminare con il dottor Starace. Desidera sapere come prenotarla?");
                            chatState.askedAboutConsultation = true;
                        }, 1500);
                    }
                    return;
                }

                // About costs
                if (containsKeywords(lowerMsg, ['costo', 'costi', 'prezzo', 'prezzi', 'quanto', 'pagamento', 'soldi', 'euro', 'investimento'])) {
                    addBotMessage("Il percorso completo dell'AEON PROCESS ha un investimento di 3.000.000 di euro per un ciclo quinquennale. Ãˆ necessaria prima una consulenza preliminare di 1.000 euro (circa 50 minuti con il dottor Aniello Starace) per valutare l'idoneitÃ  al programma.");
                    if (!chatState.askedAboutConsultation) {
                        setTimeout(() => {
                            addBotMessage("Desidera prenotare la consulenza preliminare?");
                            chatState.askedAboutConsultation = true;
                        }, 1800);
                    }
                    return;
                }

                // About consultation
                if (containsKeywords(lowerMsg, ['consulenza', 'prenotare', 'appuntamento', 'come', 'procedura', 'iniziare', 'sÃ¬', 'si', 'certo', 'ok', 'prenot'])) {
                    chatState.askedAboutConsultation = true;
                    addBotMessage("Perfetto! Per prenotare la consulenza preliminare:<br><br><strong>Costo:</strong> 1.000 euro<br><strong>Durata:</strong> circa 50 minuti<br><strong>Con:</strong> dottor Aniello Starace<br><br>DovrÃ  contattarlo direttamente via email: <strong>dottor.aniello.starace@gmail.com</strong>");
                    return;
                }
                
                // If user refuses consultation after being asked
                if (chatState.askedAboutConsultation && containsKeywords(lowerMsg, ['no', 'non voglio', 'non mi interessa', 'forse', 'ci penso'])) {
                    addBotMessage("Senza la consulenza preliminare non Ã¨ possibile accedere al programma. La ringrazio per il tempo dedicato. Buona giornata.");
                    return;
                }

                // Contact/email
                if (containsKeywords(lowerMsg, ['contatto', 'email', 'mail', 'contattare', 'scrivere'])) {
                    addBotMessage("PuÃ² contattare il dottor Aniello Starace via email: dottor.aniello.starace@gmail.com");
                    return;
                }

                // Thanks
                if (containsKeywords(lowerMsg, ['grazie', 'thanks', 'ringrazio'])) {
                    addBotMessage("Prego, Ã¨ stato un piacere. Sono a disposizione per altre domande.");
                    return;
                }

                // Goodbye
                if (containsKeywords(lowerMsg, ['arrivederci', 'bye', 'addio'])) {
                    addBotMessage("Arrivederci. Buona giornata.");
                    return;
                }

                // Default response
                addBotMessage("Posso aiutarla con informazioni sul dottor Starace, sull'AEON PROCESS, sui costi o su come prenotare una consulenza. Cosa desidera sapere?");
            }

            function containsKeywords(text, keywords) {
                return keywords.some(keyword => text.includes(keyword));
            }

            function extractFullNameWithTitle(message) {
                // Define known titles (academic, noble, professional)
                const knownTitles = {
                    'dott': 'Dottor', 'dottor': 'Dottor', 'dottore': 'Dottor', 'dott.': 'Dottor',
                    'dr': 'Dottor', 'dr.': 'Dottor', 'dottoressa': 'Dottoressa', 'dott.ssa': 'Dottoressa',
                    'prof': 'Professor', 'professor': 'Professor', 'professore': 'Professor', 'prof.': 'Professor',
                    'professoressa': 'Professoressa', 'prof.ssa': 'Professoressa',
                    'ing': 'Ingegner', 'ingegner': 'Ingegner', 'ingegnere': 'Ingegner', 'ing.': 'Ingegner',
                    'avv': 'Avvocato', 'avvocato': 'Avvocato', 'avv.': 'Avvocato', 'avvocatessa': 'Avvocatessa',
                    'arch': 'Architetto', 'architetto': 'Architetto', 'arch.': 'Architetto',
                    'conte': 'Conte', 'contessa': 'Contessa', 'marchese': 'Marchese', 'marchesa': 'Marchesa',
                    'barone': 'Barone', 'baronessa': 'Baronessa', 'duca': 'Duca', 'duchessa': 'Duchessa',
                    'principe': 'Principe', 'principessa': 'Principessa', 'don': 'Don', 'donna': 'Donna',
                    'cavaliere': 'Cavaliere', 'commendatore': 'Commendatore', 'comm.': 'Commendatore',
                    'monsignor': 'Monsignor', 'monsignore': 'Monsignor', 'vescovo': 'Vescovo',
                    'cardinale': 'Cardinale', 'reverendo': 'Reverendo', 'generale': 'Generale', 'gen.': 'Generale',
                    'ammiraglio': 'Ammiraglio', 'colonnello': 'Colonnello', 'col.': 'Colonnello',
                    'maggiore': 'Maggiore', 'capitano': 'Capitano', 'cap.': 'Capitano'
                };
                
                // Words to exclude (common words, not titles)
                const excludeWords = ['sono', 'mi', 'chiamo', 'il', 'mio', 'nome', 'Ã¨', 'presento', 
                                     'salve', 'buongiorno', 'buonasera', 'ciao', 'egregio', 'gentile', 
                                     'la', 'lo', 'un', 'una', 'di', 'da', 'in', 'con', 'su', 'per', 'a', 'che'];
                
                // Words that indicate it's NOT a name
                const notNameIndicators = [
                    'cazzo', 'cavolo', 'diavolo', 'cacchio', 'frega', 'importa', 'interessa',
                    'cazzi', 'vaffanculo', 'fanculo', 'stronzo', 'merda', 'perchÃ©', 'perchÃ¨',
                    'dovrei', 'devo', 'voglio', 'posso', 'non', 'no', 'te', 'ne'
                ];
                
                let foundTitle = null;
                let cleaned = message.replace(/[.,!?;:]/g, '').trim();
                
                // Check if message contains words that are definitely not names
                const lowerMsg = cleaned.toLowerCase();
                for (let indicator of notNameIndicators) {
                    if (lowerMsg.includes(indicator)) {
                        return null; // Not a name
                    }
                }
                
                // Split into words
                let words = cleaned.split(/\s+/);
                
                // Check for known titles first
                for (let i = 0; i < words.length; i++) {
                    const wordLower = words[i].toLowerCase();
                    if (knownTitles[wordLower]) {
                        foundTitle = knownTitles[wordLower];
                        words.splice(i, 1);
                        break;
                    }
                }
                
                // If no known title found, look for potential title
                if (!foundTitle && words.length >= 3) {
                    for (let i = 0; i < words.length - 2; i++) {
                        const wordLower = words[i].toLowerCase();
                        if (!excludeWords.includes(wordLower)) {
                            const nextWord = words[i + 1];
                            if (nextWord && nextWord[0] === nextWord[0].toUpperCase()) {
                                foundTitle = words[i].charAt(0).toUpperCase() + words[i].slice(1).toLowerCase();
                                words.splice(i, 1);
                                break;
                            }
                        }
                    }
                }
                
                // Remove exclude words
                words = words.filter(word => !excludeWords.includes(word.toLowerCase()));
                
                // Check if remaining words look like names (mostly letters, proper capitalization)
                if (words.length >= 2) {
                    // Check if words contain only letters (and maybe hyphens/apostrophes)
                    const allValidNames = words.every(word => /^[a-zA-ZÃ€-Ã¿'\-]+$/.test(word));
                    
                    if (!allValidNames) {
                        return null; // Not valid names
                    }
                    
                    const fullName = words.map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join(' ');
                    
                    return {
                        fullName: fullName,
                        title: foundTitle
                    };
                }
                
                return null;
            }

            function isRefusal(message) {
                // Check if the overall meaning is a refusal
                const refusalIndicators = [
                    /^no\b/i,
                    /non\s+(voglio|posso|intendo|desidero)/i,
                    /rifiuto/i,
                    /affari\s+miei/i,
                    /riguarda/i,
                    /privacy/i,
                    /privato/i,
                    /^nessuno$/i,
                    /non\s+dire/i,
                    /che\s+(cazzo|cavolo|diavolo|cacchio)/i,
                    /\b(frega|importa|interessa)\b/i,
                    /cazzi\s+(miei|tuoi)/i,
                    /vaffanculo/i,
                    /fanculo/i,
                    /\bstronz/i,
                    /\bmerda\b/i,
                    /perch[eÃ©]\s+(dovrei|devo)/i,
                    /non\s+sono\s+cazzi/i
                ];
                
                return refusalIndicators.some(pattern => pattern.test(message.trim()));
            }

            function detectGender(name) {
                // Simple gender detection based on first name ending
                const firstName = name.split(' ')[0].toLowerCase();
                const lastChar = firstName.charAt(firstName.length - 1);
                
                // Common male names ending in 'a'
                const maleExceptions = ['andrea', 'luca', 'mattia', 'nicola', 'elia', 'tobia'];
                
                if (maleExceptions.includes(firstName)) {
                    return 'male';
                }
                
                // Female if ends in 'a' or common female endings
                if (lastChar === 'a' || firstName.endsWith('ella') || firstName.endsWith('ina')) {
                    return 'female';
                }
                
                return 'male'; // default
            }
        });
    </script>
</body>
</html>
